<!DOCTYPE html>  <html> <head>   <title>RestAPI.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               RestAPI.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Copyright (c) 2012, salesforce.com, inc.
All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without modification, are permitted provided
that the following conditions are met:</p>

<p>Redistributions of source code must retain the above copyright notice, this list of conditions and the
   following disclaimer.</p>

<p>Redistributions in binary form must reproduce the above copyright notice, this list of conditions and
   the following disclaimer in the documentation and/or other materials provided with the distribution.</p>

<p>Neither the name of salesforce.com, inc. nor the names of its contributors may be used to endorse or
   promote products derived from this software without specific prior written permission.</p>

<p>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED
WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR
ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.</p>

<h2>Static API to access the Salesforce <a href="http://developer.force.com/REST">REST APIs on Force.com</a></h2>

<p>All methods are static so you never have to instantiate RestAPI.</p>

<h2>Usage</h2>

<pre><code>RestAPI.setInstanceUrl &lt;INSTANCE_URL&gt;
RestAPI.setSID &lt;OAUTH_ACCESS_TOKEN&gt;
RestAPI.setAuthenticator (callback) -&gt;
  # Your code to refresh the SID
  # When done invoke the callback.
  callback()
</code></pre>

<h3>Load a list of MRU contacts performing a GET request without any Id:</h3>

<pre><code>RestAPI.get RestAPI.CONTACT, null, (err, result) -&gt;
  assertNull err
  console.log 'Loaded ' + result.length + ' contacts'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">RestAPI</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h3>Constants for Salesforce <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_objects_list.htm">standard objects</a></h3>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@CONTACT = </span><span class="s">&#39;Contact&#39;</span>
  <span class="vi">@ACCOUNT = </span><span class="s">&#39;Account&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Salesforce API version</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@apiVersion = </span><span class="s">&#39;24.0&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Session Id (Access token retrieved from OAuth flow)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@sid = </span><span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Salesforce instance Url (e.g. https://na1.salesforce.com)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@instanceUrl = </span><span class="s">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h3>Function to refresh the SID</h3>

<p>The function expects the callback function as a parameter
and calls it after the session has been refreshed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@authenticator = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h3>Log function</h3>

<p>Default is <code>console.log</code>.
To disable logging just set it to <code>null</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@logFunction = </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h3>Set the session Id.</h3>

<p><code>sid</code> Session Id</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@setSID: </span><span class="nf">(sid) -&gt;</span> <span class="nv">RestAPI.sid = </span><span class="nx">sid</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h3>Set instance Url</h3>

<p><code>instanceUrl</code> Server instance Url e.g. https://na1.salesforce.com.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@setInstanceUrl: </span><span class="nf">(instanceUrl) -&gt;</span> <span class="nv">RestAPI.instanceUrl = </span><span class="nx">instanceUrl</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h3>Set authenticator</h3>

<p><code>authenticator</code> Function to refresh session Id after session expired.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@setAuthenticator: </span><span class="nf">(authenticator) -&gt;</span> <span class="nv">RestAPI.authenticator = </span><span class="nx">authenticator</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h3>Rest Url</h3>

<p><code>endpoint</code> Optional endpoint like <code>sobjects/Contact</code> <br />
Returns Rest Url containing instance url and
service endpoint with API version and optional
individual endpoint.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@getRestUrl: </span><span class="nf">(endpoint = &#39;&#39;) -&gt;</span>
    <span class="k">return</span> <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">instanceUrl</span> <span class="o">+</span> <span class="s">&#39;/services/data/v&#39;</span> <span class="o">+</span> <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">apiVersion</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">endpoint</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>GET</h3>

<p><code>sobject</code> Salesforce object. E.g. 'Contact' or 'Account' <br />
<code>id</code> Optional Id of the record or null to get MRUs <br />
<code>callback</code> Callback function <code>(err, data)</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@get: </span><span class="nf">(sobject, id, callback) -&gt;</span>
    <span class="nv">url = </span><span class="nx">RestAPI</span><span class="p">.</span><span class="nx">getRestUrl</span> <span class="s">&#39;sobjects/&#39;</span> <span class="o">+</span> <span class="nx">sobject</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Add id if a specific resource is requested.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">url</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>

    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>  <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>POST (Create)</h3>

<p><code>sobject</code> Salesforce object. E.g. 'Task' or 'Note' <br />
<code>data</code> <br />
<code>callback</code> Callback function <code>(err, data)</code>  </p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h4>Example</h4>

<p>sobject: 'Task'</p>

<pre><code>data: {
  'WhatId':'001AccountId',
  'Subject': 'Some subject',
  'Description': 'Description text',
  'Status': 'Completed'
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>sobject: 'Note'</p>

<pre><code>data: {
  'ParentId':'003ContactId',
  'Title': 'Some title',
  'Body': 'Body text',
  'IsPrivate': false
}
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@create: </span><span class="nf">(sobject, data, callback) -&gt;</span>
    <span class="nv">url = </span><span class="nx">RestAPI</span><span class="p">.</span><span class="nx">getRestUrl</span> <span class="s">&#39;sobjects/&#39;</span> <span class="o">+</span> <span class="nx">sobject</span>

    <span class="nv">payloadJSON = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span>
    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="nx">payloadJSON</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>PATCH (Update)</h3>

<p><code>sobject</code> The specified value must be a valid object for your organization.
For a complete list of objects see <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_objects_list.htm">Standard objects</a>. <br />
<code>json</code> JSON of the record to be updated <br />
<code>fields</code> JSON object with fields to be updated <br />
<code>callback</code> Callback function <code>(err, result)</code>  </p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@update: </span><span class="nf">(sobject, json, fields, callback) -&gt;</span>
    <span class="nv">type = </span><span class="s">&#39;PATCH&#39;</span>
    <span class="nv">url = </span><span class="nx">RestAPI</span><span class="p">.</span><span class="nx">getRestUrl</span> <span class="s">&#39;sobjects/&#39;</span> <span class="o">+</span> <span class="nx">sobject</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Id</span>
  
    <span class="nv">payloadJSON = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">fields</span>
    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">payloadJSON</span><span class="p">,</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>Salesforce Object Query</h3>

<p><code>query</code> <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_soql.htm">SOQL</a> query. <br />
<code>callback</code> Callback function (err, data)  </p>

<h4>Example</h4>

<pre><code>"SELECT Id, Name
FROM Contact
WHERE Account.Id = '" + accountId + "' ORDER BY Name"
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@soql: </span><span class="nf">(query, callback) -&gt;</span>
    <span class="nv">url = </span><span class="nx">RestAPI</span><span class="p">.</span><span class="nx">getRestUrl</span> <span class="s">&#39;query&#39;</span>
    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="nx">query</span><span class="p">},</span> <span class="nx">callback</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Salesforce Object Search Query</h3>

<p><code>searchTerm</code> Search term has to be at least 2 characters long <br />
<code>callback</code> Callback function (err, data)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@search: </span><span class="nf">(searchTerm, callback) -&gt;</span>
    <span class="k">if</span> <span class="nx">searchTerm</span><span class="o">?</span> <span class="o">and</span> <span class="nx">searchTerm</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>
      <span class="nv">url = </span><span class="nx">RestAPI</span><span class="p">.</span><span class="nx">getRestUrl</span> <span class="s">&#39;search&#39;</span>
      
      <span class="nv">searchTerm = </span><span class="nx">searchTerm</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/([\?&amp;|!{}\[\]\(\)\^~\*:\\&quot;&#39;+-])/g</span><span class="p">,</span> <span class="s">&#39;\\$1&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>@see <a href="http://www.salesforce.com/us/developer/docs/api/Content/sforce_api_calls_sosl_syntax.htm">SOSL Syntax</a></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">sosl = </span><span class="s">&#39;FIND { &#39;</span> <span class="o">+</span> <span class="nx">searchTerm</span> <span class="o">+</span> <span class="s">&#39;* }</span>
<span class="s">              IN Name Fields</span>
<span class="s">              RETURNING contact(name, id), account(name, id)&#39;</span>

      <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">q</span><span class="o">:</span><span class="nx">sosl</span><span class="p">},</span> <span class="nx">callback</span>
    <span class="k">else</span>
      <span class="nx">callback</span> <span class="p">{</span><span class="nv">status: </span><span class="mi">400</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>Logout</h3>

<p>Resets the session Id and instance Url.
<code>callback</code> Callback function after logout is complete.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@logout: </span><span class="nf">(callback) -&gt;</span>
    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">setSID</span> <span class="s">&#39;&#39;</span>
    <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">setInstanceUrl</span> <span class="s">&#39;&#39;</span>
    <span class="nx">callback</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>AJAX request using JQuery</h3>

<p><code>url</code> Url to request <br />
<code>type</code> GET, POST, PATCH, DELETE <br />
<code>callback</code> Callback function (err, data) <br />
<code>ignoreRetry</code> Internal flag used to only try refreshing SID once.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@ajax: </span><span class="nf">(url, type, data, callback, ignoreRetry = false) -&gt;</span>

    <span class="k">if</span> <span class="nx">logFunction</span><span class="o">?</span>
      <span class="nv">logLine = </span><span class="s">&quot;ajax </span><span class="si">#{</span><span class="nx">type</span><span class="si">}</span><span class="s">: </span><span class="si">#{</span><span class="nx">url</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="nx">logLine</span> <span class="o">+=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">strinify</span> <span class="nx">data</span> <span class="k">if</span> <span class="nx">data</span>
      <span class="nx">logFunction</span> <span class="nx">logLine</span>

    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span>
      <span class="nv">url: </span><span class="nx">url</span>
      <span class="nv">type: </span><span class="nx">type</span>
      <span class="nv">data: </span><span class="nx">data</span>
      <span class="nv">contentType: </span><span class="s">&#39;application/json; charset=utf-8&#39;</span>
      <span class="nv">dataType: </span><span class="s">&#39;json&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Sign the call with the OAuth header.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">beforeSend: </span><span class="nf">(xhr) -&gt;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s">&#39;Accept&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span> <span class="s">&#39;Authorization&#39;</span><span class="p">,</span> <span class="s">&#39;OAuth &#39;</span> <span class="o">+</span> <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">sid</span>
      <span class="nv">success: </span><span class="nf">(data) -&gt;</span>
        <span class="nx">logFunction</span><span class="o">?</span> <span class="s">&#39;success &#39;</span> <span class="o">+</span> <span class="nx">data</span>
        <span class="nx">callback</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">data</span>
      <span class="nv">error: </span><span class="nf">(err) -&gt;</span>
        <span class="nx">logFunction</span><span class="o">?</span> <span class="s">&#39;error &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">err</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>When a 401 is retrieved we expect it to be
a <em>session expiration</em> so we trigger the <code>authenticator</code>
when available. This gets only triggered if ignoreRetry
is set to false to avoid an infinite loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">401</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">ignoreRetry</span>
          <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">authenticator</span><span class="o">?</span> <span class="o">-&gt;</span>
            <span class="nx">RestAPI</span><span class="p">.</span><span class="nx">ajax</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="kc">true</span>
        <span class="nx">callback</span> <span class="nx">err</span><span class="p">,</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Export for client side JavaScript</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nv">RestAPI = </span><span class="nx">RestAPI</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Export for mocha unit test</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">module</span><span class="o">?</span><span class="p">.</span><span class="nv">exports = </span><span class="nx">RestAPI</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 